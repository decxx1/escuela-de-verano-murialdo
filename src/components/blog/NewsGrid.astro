---
import type { Noticia } from '@/types/strapi';
import Pagination from '@/components/Pagination.astro';
import { STRAPI_URL } from 'astro:env/server';
import { IS_PROD } from 'astro:env/client';

const baseUrl = !IS_PROD ? STRAPI_URL : '';

interface Props {
  noticias: Noticia[];
}

const { noticias } = Astro.props;
const newsPerPage = 12;
const totalPages = Math.ceil(noticias.length / newsPerPage);


// Función para formatear fecha
function formatearFecha(fecha: string): string {
  const date = new Date(fecha);
  return date.toLocaleDateString('es-AR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Función para truncar texto
function truncarTexto(texto: string, maxLength: number = 150): string {
  if (texto.length <= maxLength) return texto;
  return texto.substring(0, maxLength).trim() + '...';
}
---

<section class="py-8 container mx-auto">
    <section class="px-4 mx-auto max-w-7xl py-20 lg:px-6">
        <h2 class="font-atma font-bold text-outline-4 text-tertiary text-5xl text-center mb-4">Noticias</h2>
        <p class="mt-2 text-white text-xl text-center mb-12">Mantente informado sobre las últimas novedades de nuestra escuela de verano</p>
        
        <!-- Grid de Noticias -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="news-grid">
            {noticias.map((noticia, index) => (
                <article 
                    class="border-2 border-secondary rounded-3xl overflow-hidden hover:shadow-secondary hover:shadow transition-all duration-300 hover:scale-[1.02] flex flex-col news-item"
                    data-page={Math.floor(index / newsPerPage) + 1}
                    style={index >= newsPerPage ? 'display: none;' : ''}
                >
                    {/* Imagen */}
                    <a href={`/blog/${noticia.documentId}`} class="block">
                        <div class="h-64 w-full relative overflow-hidden">
                            <img
                                src={baseUrl + noticia.Imagen.formats.small.url}
                                alt={noticia.Titulo}
                                width={noticia.Imagen.formats.small.width}
                                height={noticia.Imagen.formats.small.height}
                                class="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
                                loading="lazy"
                                transition:name={noticia.documentId}
                            />
                        </div>
                    </a>

                    {/* Contenido */}
                    <div class="p-6 flex flex-col flex-1">
                        {/* Fecha */}
                        <time class="text-secondary text-sm font-semibold mb-2" datetime={noticia.createdAt}>
                            {formatearFecha(noticia.createdAt)}
                        </time>

                        {/* Título */}
                        <a href={`/blog/${noticia.documentId}`} class="block mb-3">
                            <h3 class="text-tertiary text-outline-secondary-2 font-atma font-semibold text-2xl md:text-3xl hover:text-primary transition-colors duration-200">
                                {noticia.Titulo}
                            </h3>
                        </a>

                        {/* Subtítulo (opcional) */}
                        {noticia.Subtitulo && (
                            <p class="text-white font-semibold text-base mb-3">
                                {noticia.Subtitulo}
                            </p>
                        )}

                        {/* Preview del texto */}
                        <p class="text-white/80 text-sm mb-4 flex-1">
                            {truncarTexto(noticia.Texto.replace(/[#*\-\[\]]/g, ''))}
                        </p>

                        {/* Botón Leer más */}
                        <a
                            href={`/blog/${noticia.documentId}`}
                            class="inline-flex items-center gap-2 text-secondary hover:text-tertiary font-semibold transition-colors duration-200 mt-auto"
                        >
                            Leer más
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                </article>
            ))}
        </div>

        {/* Paginación */}
        {totalPages > 1 && (
            <Pagination totalPages={totalPages} />
        )}

        {/* Mensaje si no hay noticias */}
        {noticias.length === 0 && (
            <div class="text-center py-20">
                <div class="border-2 border-primary rounded-3xl p-12 max-w-2xl mx-auto">
                    <h3 class="font-atma font-bold text-primary text-outline-2 text-3xl md:text-4xl mb-4">No hay noticias disponibles</h3>
                    <p class="text-white text-xl">
                        Pronto publicaremos novedades sobre nuestra escuela de verano.
                    </p>
                </div>
            </div>
        )}
    </section>
</section>

<script>
  document.addEventListener('astro:page-load', () => {
    let currentPage = 1;
    const newsPerPage = 12;
    const grid = document.getElementById('news-grid');
    const newsItems = grid?.querySelectorAll('.news-item') || [];
    const totalPages = Math.max(...Array.from(newsItems).map(n => parseInt(n.getAttribute('data-page') || '1')));
    
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageNumbersContainer = document.getElementById('page-numbers');
    const currentPageMobile = document.getElementById('current-page-mobile');

    function showPage(page: number) {
      currentPage = page;
      
      // Actualizar visibilidad de noticias
      newsItems.forEach((news) => {
        const newsPage = parseInt(news.getAttribute('data-page') || '1');
        if (newsPage === currentPage) {
          (news as HTMLElement).style.display = '';
        } else {
          (news as HTMLElement).style.display = 'none';
        }
      });

      // Actualizar botones
      if (prevBtn) {
        (prevBtn as HTMLButtonElement).disabled = currentPage === 1;
      }
      if (nextBtn) {
        (nextBtn as HTMLButtonElement).disabled = currentPage === totalPages;
      }

      // Actualizar indicador móvil
      if (currentPageMobile) {
        currentPageMobile.textContent = currentPage.toString();
      }

      // Actualizar display de paginación
      if ((window as any).updatePaginationDisplay) {
        (window as any).updatePaginationDisplay(currentPage);
      }

      // Scroll suave al inicio del grid
      grid?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Event listeners
    prevBtn?.addEventListener('click', () => {
      if (currentPage > 1) {
        showPage(currentPage - 1);
      }
    });

    nextBtn?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        showPage(currentPage + 1);
      }
    });

    // Delegación de eventos para botones de página
    pageNumbersContainer?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('page-btn')) {
        const page = parseInt(target.getAttribute('data-page') || '1');
        showPage(page);
      }
    });
  });
</script>
