---
import type { Album } from '@/types/strapi';
import Pagination from '@/components/Pagination.astro';
import { STRAPI_URL } from 'astro:env/server';
import { IS_PROD } from 'astro:env/client';

const baseUrl = !IS_PROD ? STRAPI_URL : '';

interface Props {
  albumes: Album[];
}

const { albumes } = Astro.props;
const albumsPerPage = 12;
const totalPages = Math.ceil(albumes.length / albumsPerPage);


// Función para formatear fecha
function formatearFecha(fecha: string): string {
  const date = new Date(fecha);
  return date.toLocaleDateString('es-AR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<section class="py-8 container mx-auto">
    <section class="px-4 mx-auto max-w-7xl py-20 lg:px-6">
        <h2 class="font-atma font-bold text-outline-4 text-tertiary text-5xl text-center mb-4">Galería de Fotos</h2>
        <p class="mt-2 text-white text-xl text-center mb-12">Revive los mejores momentos de nuestra escuela de verano</p>
        
        <!-- Grid de Álbumes -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="albums-grid">
            {albumes.map((album, index) => {
                // Obtener la primera foto como portada
                const portada = album.Fotos[0];
                const totalFotos = album.Fotos.length;
                
                return (
                    <article 
                        class="border-2 border-secondary rounded-3xl overflow-hidden hover:shadow-secondary hover:shadow transition-all duration-300 hover:scale-[1.02] flex flex-col album-item"
                        data-page={Math.floor(index / albumsPerPage) + 1}
                        style={index >= albumsPerPage ? 'display: none;' : ''}
                    >
                        {/* Imagen de portada */}
                        <a href={`/galeria/${album.documentId}`} class="block relative">
                            <div class="h-72 w-full relative overflow-hidden">
                                {portada && (
                                    <img
                                        src={baseUrl + portada.formats?.small?.url || 'images/logo/logo.png'}
                                        alt={album.Nombre}
                                        width={portada.formats?.small?.width || 500}
                                        height={portada.formats?.small?.height || 363}
                                        class="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
                                        loading="lazy"
                                    />
                                )}
                                
                                {/* Overlay con contador de fotos */}
                                <div class="absolute inset-0 bg-linear-to-t from-primary/90 via-primary/30 to-transparent flex items-end justify-center pb-6">
                                    <div class="flex items-center gap-2 text-white">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                        <span class="text-lg font-semibold">{totalFotos} {totalFotos === 1 ? 'foto' : 'fotos'}</span>
                                    </div>
                                </div>
                            </div>
                        </a>

                        {/* Contenido */}
                        <div class="p-6 flex flex-col flex-1">
                            {/* Fecha */}
                            <time class="text-secondary text-sm font-semibold mb-2" datetime={album.createdAt}>
                                {formatearFecha(album.createdAt)}
                            </time>

                            {/* Nombre del álbum */}
                            <a href={`/galeria/${album.documentId}`} class="block mb-4">
                                <h3 class="text-tertiary text-outline-secondary-2 font-atma font-semibold text-2xl md:text-3xl hover:text-primary transition-colors duration-200">
                                    {album.Nombre}
                                </h3>
                            </a>

                            {/* Botón Ver álbum */}
                            <a
                                href={`/galeria/${album.documentId}`}
                                class="inline-flex items-center gap-2 text-secondary hover:text-tertiary font-semibold transition-colors duration-200 mt-auto"
                            >
                                Ver álbum
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </a>
                        </div>
                    </article>
                );
            })}
        </div>

        {/* Paginación */}
        {totalPages > 1 && (
            <Pagination totalPages={totalPages} />
        )}

        {/* Mensaje si no hay álbumes */}
        {albumes.length === 0 && (
            <div class="text-center py-20">
                <div class="border-2 border-primary rounded-3xl p-12 max-w-2xl mx-auto">
                    <h3 class="font-atma font-bold text-primary text-outline-2 text-3xl md:text-4xl mb-4">No hay álbumes disponibles</h3>
                    <p class="text-white text-xl">
                        Pronto publicaremos fotos de nuestra escuela de verano.
                    </p>
                </div>
            </div>
        )}
    </section>
</section>

<script>
  document.addEventListener('astro:page-load', () => {
    let currentPage = 1;
    const albumsPerPage = 12;
    const grid = document.getElementById('albums-grid');
    const albums = grid?.querySelectorAll('.album-item') || [];
    const totalPages = Math.max(...Array.from(albums).map(a => parseInt(a.getAttribute('data-page') || '1')));
    
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageNumbersContainer = document.getElementById('page-numbers');
    const currentPageMobile = document.getElementById('current-page-mobile');

    function showPage(page: number) {
      currentPage = page;
      
      // Actualizar visibilidad de álbumes
      albums.forEach((album) => {
        const albumPage = parseInt(album.getAttribute('data-page') || '1');
        if (albumPage === currentPage) {
          (album as HTMLElement).style.display = '';
        } else {
          (album as HTMLElement).style.display = 'none';
        }
      });

      // Actualizar botones
      if (prevBtn) {
        (prevBtn as HTMLButtonElement).disabled = currentPage === 1;
      }
      if (nextBtn) {
        (nextBtn as HTMLButtonElement).disabled = currentPage === totalPages;
      }

      // Actualizar indicador móvil
      if (currentPageMobile) {
        currentPageMobile.textContent = currentPage.toString();
      }

      // Actualizar display de paginación
      if ((window as any).updatePaginationDisplay) {
        (window as any).updatePaginationDisplay(currentPage);
      }

      // Scroll suave al inicio del grid
      grid?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Event listeners
    prevBtn?.addEventListener('click', () => {
      if (currentPage > 1) {
        showPage(currentPage - 1);
      }
    });

    nextBtn?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        showPage(currentPage + 1);
      }
    });

    // Delegación de eventos para botones de página
    pageNumbersContainer?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('page-btn')) {
        const page = parseInt(target.getAttribute('data-page') || '1');
        showPage(page);
      }
    });
  });
</script>
