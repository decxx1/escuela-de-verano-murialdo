---
import Layout from '@/layouts/Layout.astro';
import Pagination from '@/components/Pagination.astro';
import { galeriasService } from '@/services/strapi';
import type { Album } from '@/types/strapi';
import { STRAPI_URL } from 'astro:env/server';

// Función para formatear fecha
function formatearFecha(fecha: string): string {
  const date = new Date(fecha);
  return date.toLocaleDateString('es-AR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

const isLocalHost = Astro.url.hostname === 'localhost' || Astro.url.hostname === '127.0.0.1';
const baseUrl = isLocalHost ? STRAPI_URL : '';

// getStaticPaths para generar todas las páginas en build time
export async function getStaticPaths() {
  try {
    // OPTIMIZACIÓN: Obtener todos los álbumes para generar páginas estáticas
    // Si tienes más de 500 álbumes, considera usar SSR (output: 'server') en astro.config
    const response = await galeriasService.getGalerias(1, 500);
    
    return response.data.map((album) => ({
      params: { slug: album.documentId },
      props: { albumId: album.documentId },
    }));
  } catch (error) {
    console.error('Error al obtener álbumes para getStaticPaths:', error);
    return [];
  }
}

// Obtener parámetros
const { slug } = Astro.params;
const { albumId } = Astro.props as { albumId: string };

const pageSize = 10;

// OPTIMIZACIÓN: Obtener el álbum completo
// NOTA: Esto carga TODAS las fotos del álbum en el HTML
// Para álbumes con >100 fotos, considera:
// 1. Usar SSR con paginación real de API
// 2. Implementar lazy loading con Intersection Observer
// 3. Cargar fotos bajo demanda con fetch
let album: Album;
let todasLasFotos: any[] = [];
let totalFotos = 0;
let totalPages = 1;

try {
  const response = await galeriasService.getAlbumByDocumentId(albumId);
  album = response.data;
  todasLasFotos = album.Fotos || [];
  
  // Calcular paginación
  totalFotos = todasLasFotos.length;
  totalPages = Math.ceil(totalFotos / pageSize);
} catch (error) {
  console.error('Error al obtener álbum:', error);
  return Astro.redirect('/galeria');
}

const preloadImages = todasLasFotos.length > 0 ? [
  {
    href: baseUrl + todasLasFotos[0].formats.small.url,
    as: "image",
    type: "image/jpeg",
  }
] : [];
---

<Layout
  title={`${album.Nombre} - Galería - Escuela de verano Club Leonardo Murialdo`}
  canonical={`https://escueladeveranomurialdo.com.ar/galeria/${album.documentId}`}
  metaDescription={`Fotos del álbum ${album.Nombre} de la Escuela de Verano del Club Leonardo Murialdo. ${album.Fotos.length} fotos disponibles.`}
  metaImg={todasLasFotos.length > 0 ? baseUrl + todasLasFotos[0].url : "https://escueladeveranomurialdo.com.ar/images/index/escuela-de-verano.webp"}
  preLoad={preloadImages}
>
  <section class="pt-44 pb-20 sm:pb-20 sm:pt-36 container mx-auto">
    <article class="px-4 mx-auto max-w-7xl sm:py-20 lg:px-6">
      {/* Fecha */}
      <time class="text-secondary text-base font-semibold mb-4 block" datetime={album.createdAt}>
        {formatearFecha(album.createdAt)}
      </time>

      {/* Título del álbum */}
      <h1 class="font-atma font-bold text-outline-4 text-tertiary text-4xl md:text-5xl lg:text-6xl mb-4">
        {album.Nombre}
      </h1>

      {/* Contador de fotos */}
      <p class="text-white text-lg mb-8">
        <span id="foto-count">{totalFotos}</span> {totalFotos === 1 ? 'foto' : 'fotos'} en total
        {totalPages > 1 && (
          <span class="text-secondary ml-2" id="page-indicator">
            (Página <span id="current-page">1</span> de {totalPages})
          </span>
        )}
      </p>

      {/* Grid de fotos estilo bento/mosaico */}
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-12" id="gallery">
        {todasLasFotos.map((foto, index) => (
          <a
            class="relative overflow-hidden rounded-2xl border-2 border-secondary hover:border-tertiary transition-all duration-300 hover:scale-105 cursor-pointer group"
            style={`aspect-ratio: ${foto.width}/${foto.height}; ${index >= pageSize ? 'display: none;' : ''}`}
            data-pswp-width={foto.width}
            data-pswp-height={foto.height}
            data-pswp-src={baseUrl + foto.url}
            data-page={Math.floor(index / pageSize) + 1}
          >
            <img
              src={baseUrl + foto.formats?.small?.url || '../images/logo/logo.png'}
              alt={foto.name}
              width={foto.formats?.small?.width || 500}
              height={foto.formats?.small?.height || 363}
              class="w-full h-full object-cover"
              loading="lazy"
            />
            
            {/* Overlay con icono de zoom */}
            <div class="absolute inset-0 bg-primary/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
                <line x1="11" y1="8" x2="11" y2="14"/>
                <line x1="8" y1="11" x2="14" y2="11"/>
              </svg>
            </div>
          </a>
        ))}
      </div>

      {/* Paginación */}
      {totalPages > 1 && (
        <Pagination totalPages={totalPages} />
      )}

      {/* Botón volver */}
      <div class="mt-12 pt-8 border-t-2 border-secondary/30">
        <a
          href="/galeria"
          class="inline-flex items-center gap-2 text-secondary hover:text-tertiary font-semibold text-lg transition-colors duration-200"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Volver a Galería
        </a>
      </div>
    </article>
  </section>
</Layout>

<!-- Paginación y PhotoSwipe Script -->
<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', () => {
    // Variables de paginación
    let currentPage = 1;
    const pageSize = 10;
    const gallery = document.getElementById('gallery');
    const photos = gallery?.querySelectorAll('a[data-page]') || [];
    const totalPages = Math.max(...Array.from(photos).map(p => parseInt(p.getAttribute('data-page') || '1')));
    
    // Elementos del DOM
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageButtons = document.querySelectorAll('.page-btn');
    const currentPageSpan = document.getElementById('current-page');
    const currentPageMobile = document.getElementById('current-page-mobile');

    // Función para mostrar página
    function showPage(page: number) {
      currentPage = page;
      
      // Actualizar visibilidad de fotos
      photos.forEach((photo) => {
        const photoPage = parseInt(photo.getAttribute('data-page') || '1');
        if (photoPage === currentPage) {
          (photo as HTMLElement).style.display = '';
        } else {
          (photo as HTMLElement).style.display = 'none';
        }
      });

      // Actualizar botones de paginación
      if (prevBtn) {
        (prevBtn as HTMLButtonElement).disabled = currentPage === 1;
      }
      if (nextBtn) {
        (nextBtn as HTMLButtonElement).disabled = currentPage === totalPages;
      }

      // Actualizar indicador de página (desktop)
      if (currentPageSpan) {
        currentPageSpan.textContent = currentPage.toString();
      }

      // Actualizar indicador de página (móvil)
      if (currentPageMobile) {
        currentPageMobile.textContent = currentPage.toString();
      }

      // Actualizar display de paginación (números de página dinámicos)
      if ((window as any).updatePaginationDisplay) {
        (window as any).updatePaginationDisplay(currentPage);
      }

      // Scroll suave al inicio de la galería
      gallery?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Event listeners para botones
    prevBtn?.addEventListener('click', () => {
      if (currentPage > 1) {
        showPage(currentPage - 1);
      }
    });

    nextBtn?.addEventListener('click', () => {
      if (currentPage < totalPages) {
        showPage(currentPage + 1);
      }
    });

    // Delegación de eventos para botones de página (ya que se generan dinámicamente)
    const pageNumbersContainer = document.getElementById('page-numbers');
    pageNumbersContainer?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('page-btn')) {
        const page = parseInt(target.getAttribute('data-page') || '1');
        showPage(page);
      }
    });

    // Inicializar PhotoSwipe
    const lightbox = new PhotoSwipeLightbox({
      gallery: '#gallery',
      children: 'a[data-page]',
      pswpModule: () => import('photoswipe'),
      // Opciones de PhotoSwipe
      bgOpacity: 0.95,
      spacing: 0.1,
      allowPanToNext: true,
      zoom: true,
      close: true,
      arrowKeys: true,
      returnFocus: true,
      clickToCloseNonZoomable: true,
      imageClickAction: 'zoom',
      tapAction: 'toggle-controls',
      doubleTapAction: 'zoom',
      preloaderDelay: 0,
      showHideAnimationType: 'zoom',
    });
    
    lightbox.init();
  });
</script>

<style>
  /* Estilos personalizados para PhotoSwipe */
  :global(.pswp) {
    --pswp-bg: rgba(13, 27, 42, 0.95);
    --pswp-icon-color: #FFC107;
    --pswp-icon-color-secondary: #00BCD4;
  }
  
  :global(.pswp__button) {
    background-color: rgba(13, 27, 42, 0.8) !important;
  }
  
  :global(.pswp__button:hover) {
    background-color: rgba(13, 27, 42, 1) !important;
  }
</style>
